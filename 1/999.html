<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XML Formatter and Validator</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.6/codemirror.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .CodeMirror {
            height: auto;
            border: 1px solid #ccc;
            font-size: 14px;
        }
        #message {
            margin-bottom: 10px;
        }
        .valid {
            color: green;
        }
        .invalid {
            color: red;
        }
        .line-error {
            background-color: #fdd !important;
        }
    </style>
</head>
<body>
    <h1>XML Formatter and Validator</h1>
    <textarea id="inputXml" placeholder="Paste your XML here"></textarea>
    <button onclick="formatAndValidateXml()">Format and Validate XML</button>
    <div id="message"></div>
    <h2>Formatted XML:</h2>
    <pre id="outputXml"></pre>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.6/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.6/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.6/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.6/addon/edit/matchtags.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.6/addon/selection/active-line.min.js"></script>

    <script>
        var editor = CodeMirror.fromTextArea(document.getElementById("inputXml"), {
            mode: "application/xml",
            lineNumbers: true,
            matchTags: { bothTags: true },
            autoCloseBrackets: true,
            styleActiveLine: true
        });

        function formatAndValidateXml() {
            var inputXml = editor.getValue();
            var messageDiv = document.getElementById("message");
            var outputDiv = document.getElementById("outputXml");

            // Очистить предыдущие подсветки ошибок
            for (let i = 0; i < editor.lineCount(); i++) {
                editor.removeLineClass(i, 'background', 'line-error');
            }

            try {
                var parser = new DOMParser();
                var xmlDoc = parser.parseFromString(inputXml, "application/xml");

                var parseError = xmlDoc.getElementsByTagName("parsererror");
                if (parseError.length > 0) {
                    throw new Error(parseError[0].textContent);
                }

                var formattedXml = formatXmlText(new XMLSerializer().serializeToString(xmlDoc.documentElement));
                outputDiv.textContent = formattedXml;
                messageDiv.textContent = "Your XML is valid";
                messageDiv.className = "valid";
            } catch (e) {
                highlightErrorLine(e.message);
                messageDiv.textContent = "XML Error: " + e.message;
                messageDiv.className = "invalid";
                outputDiv.textContent = "";
            }
        }

        function formatXmlText(xml) {
            var reg = /(>)(<)(\/*)/g;
            var wsexp = / *(.*) +\n/g;
            var contexp = /(<.+>)(.+\n)/g;
            xml = xml.replace(/\r\n/g, '\n');
            xml = xml.replace(reg, '$1\n$2$3');
            xml = xml.replace(wsexp, '$1\n');
            xml = xml.replace(contexp, '$1\n$2');
            var pad = 0;
            var formatted = '';
            var lines = xml.split('\n');
            var indent = 0;
            var lastType = 'other';
            var transitions = {
                'single->single': 0,
                'single->closing': -1,
                'single->opening': 0,
                'single->other': 0,
                'closing->single': 0,
                'closing->closing': -1,
                'closing->opening': 0,
                'closing->other': 0,
                'opening->single': 1,
                'opening->closing': 0,
                'opening->opening': 1,
                'opening->other': 1,
                'other->single': 0,
                'other->closing': -1,
                'other->opening': 0,
                'other->other': 0
            };

            for (var i = 0; i < lines.length; i++) {
                var ln = lines[i];

                var single = Boolean(ln.match(/<.+\/>/)); 
                var closing = Boolean(ln.match(/<\/.+>/)); 
                var opening = Boolean(ln.match(/<[^!].*>/)); 

                var type = single ? 'single' : closing ? 'closing' : opening ? 'opening' : 'other';

                var fromTo = lastType + '->' + type;
                lastType = type;
                var padding = '';

                indent += transitions[fromTo];
                for (var j = 0; j < indent; j++) {
                    padding += '  ';
                }
                formatted += padding + ln + '\n';
            }

            return formatted;
        }

        function highlightErrorLine(message) {
            var lines = editor.getValue().split("\n");
            var errorLine = -1;
            var match = message.match(/line (\d+)/);
            if (match) {
                errorLine = parseInt(match[1]) - 1; // CodeMirror uses zero-based index for lines
            }

            if (errorLine >= 0 && errorLine < lines.length) {
                editor.addLineClass(errorLine, 'background', 'line-error');
            }
        }
    </script>
</body>
</html>
