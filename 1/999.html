<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XML Formatter and Validator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .textarea-wrapper {
            position: relative;
            display: flex;
        }
        .line-numbers {
            counter-reset: line;
            padding: 10px;
            border-right: 1px solid #ccc;
            user-select: none;
            background: #f5f5f5;
        }
        .line-numbers div {
            counter-increment: line;
            text-align: right;
        }
        .line-numbers div::before {
            content: counter(line);
            display: block;
            padding-right: 10px;
            color: #888;
        }
        #inputXml {
            border: 1px solid #ccc;
            padding: 10px;
            margin: 0;
            width: 100%;
            font-family: monospace;
            white-space: pre;
            outline: none;
            resize: none;
        }
        #message {
            margin-bottom: 10px;
        }
        .valid {
            color: green;
        }
        .invalid {
            color: red;
        }
        .error-highlight {
            background-color: #fdd;
        }
    </style>
</head>
<body>
    <h1>XML Formatter and Validator</h1>
    <div class="textarea-wrapper">
        <div class="line-numbers" id="lineNumbers"></div>
        <textarea id="inputXml" placeholder="Paste your XML here" oninput="updateLineNumbers()" onscroll="syncScroll()"></textarea>
    </div>
    <button onclick="formatAndValidateXml()">Format and Validate XML</button>
    <div id="message"></div>
    <h2>Formatted XML:</h2>
    <pre id="outputXml"></pre>

    <script>
        function updateLineNumbers() {
            const textarea = document.getElementById('inputXml');
            const lineNumbers = document.getElementById('lineNumbers');
            const lines = textarea.value.split('\n').length;
            lineNumbers.innerHTML = '';
            for (let i = 1; i <= lines; i++) {
                const div = document.createElement('div');
                div.textContent = i;
                lineNumbers.appendChild(div);
            }
        }

        function syncScroll() {
            const textarea = document.getElementById('inputXml');
            const lineNumbers = document.getElementById('lineNumbers');
            lineNumbers.scrollTop = textarea.scrollTop;
        }

        function formatAndValidateXml() {
            const textarea = document.getElementById('inputXml');
            const messageDiv = document.getElementById('message');
            const outputDiv = document.getElementById('outputXml');
            const inputXml = textarea.value;

            // Удаляем предыдущие подсветки ошибок
            textarea.classList.remove('error-highlight');

            try {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(inputXml, "application/xml");

                const parseError = xmlDoc.getElementsByTagName("parsererror");
                if (parseError.length > 0) {
                    throw new Error(parseError[0].textContent);
                }

                const formattedXml = formatXmlText(new XMLSerializer().serializeToString(xmlDoc.documentElement));
                outputDiv.textContent = formattedXml;
                messageDiv.textContent = "Your XML is valid";
                messageDiv.className = "valid";
            } catch (e) {
                highlightErrorLine(e.message);
                messageDiv.textContent = "XML Error: " + e.message;
                messageDiv.className = "invalid";
                outputDiv.textContent = "";
            }
        }

        function formatXmlText(xml) {
            const reg = /(>)(<)(\/*)/g;
            const wsexp = / *(.*) +\n/g;
            const contexp = /(<.+>)(.+\n)/g;
            xml = xml.replace(/\r\n/g, '\n');
            xml = xml.replace(reg, '$1\n$2$3');
            xml = xml.replace(wsexp, '$1\n');
            xml = xml.replace(contexp, '$1\n$2');
            let pad = 0;
            let formatted = '';
            const lines = xml.split('\n');
            let indent = 0;
            let lastType = 'other';
            const transitions = {
                'single->single': 0,
                'single->closing': -1,
                'single->opening': 0,
                'single->other': 0,
                'closing->single': 0,
                'closing->closing': -1,
                'closing->opening': 0,
                'closing->other': 0,
                'opening->single': 1,
                'opening->closing': 0,
                'opening->opening': 1,
                'opening->other': 1,
                'other->single': 0,
                'other->closing': -1,
                'other->opening': 0,
                'other->other': 0
            };

            for (let i = 0; i < lines.length; i++) {
                let ln = lines[i];

                let single = Boolean(ln.match(/<.+\/>/)); 
                let closing = Boolean(ln.match(/<\/.+>/)); 
                let opening = Boolean(ln.match(/<[^!].*>/)); 

                let type = single ? 'single' : closing ? 'closing' : opening ? 'opening' : 'other';

                let fromTo = lastType + '->' + type;
                lastType = type;
                let padding = '';

                indent += transitions[fromTo];
                for (let j = 0; j < indent; j++) {
                    padding += '  ';
                }
                formatted += padding + ln + '\n';
            }

            return formatted;
        }

        function highlightErrorLine(message) {
            const textarea = document.getElementById('inputXml');
            const lines = textarea.value.split('\n');
            let errorLine = -1;
            const match = message.match(/line (\d+)/);
            if (match) {
                errorLine = parseInt(match[1]) - 1; // Zero-based index for lines
            }

            if (errorLine >= 0 && errorLine < lines.length) {
                textarea.classList.add('error-highlight');
                const lineNumbers = document.getElementById('lineNumbers').children;
                if (lineNumbers[errorLine]) {
                    lineNumbers[errorLine].classList.add('error-highlight');
                }
            }
        }

        window.onload = function() {
            updateLineNumbers();
        }
    </script>
</body>
</html>
